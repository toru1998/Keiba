データを読み込んでいます...
前処理を実行中...
データを分割中...
総レース数: 51813
時系列CV Fold数: 3
代表Fold - 学習用レース数: 31087, 検証用レース数: 5182, テスト用レース数: 15544
学習データサンプル数: 447591, 検証データサンプル数: 71881, テストデータサンプル数: 213805
LightGBMモデルを学習中...

[方針] validの回収率でモデル/閾値を選定し、testは最後に1回だけ評価します

[特徴量設定] prior_n=50, dist_bin_width=400 (固定)

[採用特徴量設定] prior_n=50, dist_bin_width=400

[時系列CV] 3つのFoldでモデルを評価します

[候補] P1_regularized を3つのFoldで評価...
Training until validation scores don't improve for 50 rounds
Did not meet early stopping. Best iteration is:
[1499]	valid_0's multi_logloss: 0.909377
Training until validation scores don't improve for 50 rounds
Did not meet early stopping. Best iteration is:
[1497]	valid_0's multi_logloss: 0.926661
Training until validation scores don't improve for 50 rounds
Did not meet early stopping. Best iteration is:
[1500]	valid_0's multi_logloss: 0.944864
  Fold回収率: [85.04097146806198, 88.40270501952568, 86.68765007463172] → 平均: 86.71%, 最小: 85.04%, CV安定: True

[候補] P3_high_reg を3つのFoldで評価...
Training until validation scores don't improve for 50 rounds
Did not meet early stopping. Best iteration is:
[1200]	valid_0's multi_logloss: 0.936704
Training until validation scores don't improve for 50 rounds
Did not meet early stopping. Best iteration is:
[1200]	valid_0's multi_logloss: 0.954601
Training until validation scores don't improve for 50 rounds
Did not meet early stopping. Best iteration is:
[1200]	valid_0's multi_logloss: 0.971783
  Fold回収率: [87.3450151057402, 84.15249125346845, 86.57867193859751] → 平均: 86.03%, 最小: 84.15%, CV安定: True

[モデル選定結果] CVの平均回収率で比較
            model  cv_avg_return(%)  cv_min_return(%)  ... proba_thr  ev_thr   bets
0  P1_regularized         86.710442         85.040971  ...       0.1     2.0  15409
1     P3_high_reg         86.025393         84.152491  ...       0.2     2.0   8599

[2 rows x 10 columns]

[最終学習] 選定されたモデル P1_regularized を全Trainデータで再学習...

[キャリブレーション] Validデータで Isotonic Regression を学習...
  Isotonic Regression 学習完了

[戦略再探索] Isotonic補正後EVでvalidの閾値を再探索...
  [採用(補正後EV)] proba_mode=raw, place>=0.4, proba>=0.2, EV>=2.0 (valid回収率=1185.46%, 購入数=2398, stable=False)

[採用] model=P1_regularized, cv_avg_return=86.71%, cv_min=85.04%, (CV戦略) proba_mode=raw, place>=0.0, proba>=0.1, EV>=2.0 (購入数=15409, cv_stable=True)
[採用] test評価に使用: 補正後EV戦略 proba_mode=raw, place>=0.4, proba>=0.2, EV>=2.0

評価結果:
正解率 (Accuracy): 0.6297

分類レポート:
              precision    recall  f1-score   support

         その他       0.89      0.73      0.80    167137
          1着       0.24      0.47      0.31     15572
          2着       0.13      0.18      0.15     15540
          3着       0.11      0.18      0.13     15556

    accuracy                           0.63    213805
   macro avg       0.34      0.39      0.35    213805
weighted avg       0.73      0.63      0.67    213805


特徴量の重要度:
          feature  importance
16          騎手コード       38248
18           生産者名       32438
9             父馬名       31849
17         調教師コード       26845
15          単勝オッズ        4496
41        prev_場所        2286
50     wma5_着差タイム        2250
24          過去複勝率        2192
55       interval        2079
0              場所        1805
44      prev_確定着順        1716
23           過去勝率        1709
45     prev_着差タイム        1519
32       芝ダ適性_複勝率        1497
36       距離適性_複勝率        1496
38     prev_平均通過順        1458
49       wma5_PCI        1385
31        芝ダ適性_勝率        1337
21          馬体重変化        1318
14            人気順        1290
26     コース適性_平均着順        1290
34      距離適性_平均着順        1267
48  wma5_上がり3Fタイム        1232
30      芝ダ適性_平均着順        1228
13             馬番        1194
22         過去平均着順        1180
47       avg5_PCI        1175
35        距離適性_勝率        1152
39      prev_脚質指数        1052
46  avg5_上がり3Fタイム        1011
28      コース適性_複勝率         992
27       コース適性_勝率         757
12             頭数         692
51           騎手勝率         632
33       芝ダ適性_出走数         622
40      avg5_通過順1         605
11            馬体重         595
25          過去出走数         562
52          調教師勝率         558
37       距離適性_出走数         551
20           斤量変化         395
29      コース適性_出走数         393
42        prev_距離         365
2          クラスコード         299
5              距離         227
10             斤量         169
8              年齢         147
6            馬場状態          98
7              性別          57
53          昇級フラグ          57
54          降級フラグ          42
43       prev_芝・ダ          35
19          長距離輸送          34
4         トラックコード          25
3             芝・ダ          21
1             所属地           7

期待値（確率 × オッズ）によるパフォーマンス分析:
testで戦略を比較: CV戦略(補正前) vs 補正後EV戦略
  CV戦略(補正前): proba_mode=raw, place>=0.0, proba>=0.1, EV>=2.0
  補正後EV戦略: proba_mode=raw, place>=0.4, proba>=0.2, EV>=2.0
          戦略  proba閾値  期待値閾値  ...     回収率(%)    期待回収率(%)     実績/期待
0  CV戦略(補正前)      0.1    2.0  ...  82.092519  381.360784  0.215262
1    補正後EV戦略      0.2    2.0  ...  91.463872  426.878051  0.214262

[2 rows x 10 columns]

期待値が高い馬のサンプル (TOP 10) [補正後EV戦略]:
           年   月   日  ... expected_value expected_value_calibrated  target
512153  2020  10  11  ...      75.967859                 69.980952       0
643851  2023   7   8  ...      52.282517                 54.604121       0
719695  2024   4  21  ...      46.469529                 49.551374       0
577340  2021  12  11  ...      47.761188                 44.176667       0
519729  2020   9  19  ...      59.285121                 44.144304       0
618207  2022   1   8  ...      36.762813                 41.802053       0
656458  2023  10  29  ...      48.385630                 39.336623       0
624778  2022  12  17  ...      37.189470                 39.222018       0
669594  2023  12   3  ...      35.385861                 38.302346       0
662014  2023   4  16  ...      34.878536                 36.460165       0

[10 rows x 11 columns]

的中馬の期待値TOP10 (的中数=370):
           年   月   日  ... expected_value expected_value_calibrated  target
553477  2021   8  21  ...      18.392768                 22.090196       1
504527  2020   8   9  ...      13.219818                 14.452493       1
626449  2022   3  12  ...      12.307969                 14.400000       1
595878  2022   4  30  ...       8.366880                 10.125316       1
621803  2022   5  28  ...       8.882788                  9.875336       1
654280  2023   6  11  ...       7.783533                  9.105303       1
538013  2020  11  21  ...       7.111562                  8.704219       1
622441  2022   6  11  ...      11.755858                  8.120749       1
565203  2021   3   6  ...      12.031854                  8.077987       1
581875  2021   6  19  ...      11.299561                  7.946110       1

[10 rows x 11 columns]

的中/非的中の特徴量比較 [購入対象内]:
                              hit_mean   hit_median  ...  miss_median       diff
距離                         1664.891892  1700.000000  ...  1600.000000  33.609962
prev_距離                    1661.295775  1600.000000  ...  1600.000000  14.936258
wma5_着差タイム                    5.955052     0.800000  ...     0.811290  -2.979039
prev_着差タイム                    6.509577     0.700000  ...     0.700000  -2.936747
単勝オッズ                         7.902973     7.100000  ...     8.100000  -2.773564
馬体重                         473.854054   472.000000  ...   476.000000  -1.877261
interval                     50.202817    28.000000  ...    29.000000  -1.788120
expected_value                3.965361     3.443620  ...     3.913385  -1.227979
expected_value_calibrated     3.626655     3.069088  ...     3.434897  -0.946589
人気順                           3.794595     3.000000  ...     4.000000  -0.591404
prev_平均通過順                    4.194366     3.500000  ...     3.750000  -0.403192
馬体重変化                         1.960563     0.000000  ...     0.000000   0.299939
馬番                            7.694595     8.000000  ...     8.000000  -0.280334
コース適性_出走数                     1.872973     1.000000  ...     1.000000  -0.235826
prev_確定着順                     5.290141     4.000000  ...     5.000000  -0.233021
頭数                           14.275676    15.000000  ...    15.000000  -0.232366
芝ダ適性_出走数                      8.505405     6.000000  ...     7.000000   0.182321
距離適性_出走数                      5.843243     4.000000  ...     4.000000  -0.182301
wma5_上がり3Fタイム                35.932733    36.648387  ...    36.654839  -0.142771
avg5_通過順1                     2.726808     1.400000  ...     1.400000  -0.127825

[20 rows x 5 columns]

======================================================================
EV評価分析（全テストデータ対象）
======================================================================

[EV10分位ごとの実績]
 ev_decile  n_bets  n_hits  hit_rate   avg_odds  avg_proba   avg_ev   ev_min    ev_max  return_rate  expected_return
         0   21305     633  0.029711 147.228336   0.012835 0.260398 0.000661  0.511839    50.489556        26.039845
         1   21304    2002  0.093973  78.329539   0.089627 0.730291 0.511873  0.924858    68.525160        73.029117
         2   21304    3259  0.152976  50.697564   0.203345 1.079071 0.924876  1.222959    72.044686       107.907137
         3   21304    2762  0.129647  42.219654   0.221782 1.361475 1.222972  1.501229    71.397860       136.147534
         4   21304    2117  0.099371  43.371827   0.211689 1.653261 1.501245  1.813435    74.256008       165.326107
         5   21304    1663  0.078060  46.444818   0.191050 1.995786 1.813465  2.189930    73.320973       199.578593
         6   21304    1184  0.055576  50.937603   0.172028 2.416997 2.189942  2.666785    73.242584       241.699684
         7   21304     879  0.041260  59.087955   0.151280 2.979368 2.666794  3.336599    77.037646       297.936833
         8   21304     696  0.032670  68.240100   0.135937 3.848468 3.336605  4.488065    84.591157       384.846836
         9   21304     377  0.017696  85.540734   0.141442 6.495908 4.488137 75.967859    70.702685       649.590755

[期待回収率 vs 実績回収率（EV分位別）]
 ev_decile  expected_return  return_rate  return_vs_expected
         0        26.039845    50.489556            1.938935
         1        73.029117    68.525160            0.938327
         2       107.907137    72.044686            0.667655
         3       136.147534    71.397860            0.524415
         4       165.326107    74.256008            0.449149
         5       199.578593    73.320973            0.367379
         6       241.699684    73.242584            0.303031
         7       297.936833    77.037646            0.258570
         8       384.846836    84.591157            0.219805
         9       649.590755    70.702685            0.108842

[全体サマリ]
  購入数: 213041
  的中数: 15572
  的中率: 0.0731
  実績回収率: 71.56%
  期待回収率(平均EV): 228.21%
  実績/期待: 0.3136

[キャリブレーション評価]
  Brier Score: 0.073629 (低いほど良い)

  キャリブレーション曲線（10分位）:
 prob_pred (予測確率)  prob_true (実績勝率)  diff (実績-予測)
         0.002138          0.003695      0.001557
         0.009848          0.007109     -0.002738
         0.023749          0.014171     -0.009578
         0.045709          0.023012     -0.022697
         0.075992          0.033067     -0.042925
         0.115631          0.049906     -0.065724
         0.165854          0.066370     -0.099483
         0.230881          0.105795     -0.125086
         0.323338          0.148410     -0.174928
         0.532887          0.276788     -0.256099

  平均キャリブレーション誤差: 0.080082

======================================================================
Isotonic補正後のEV評価（補正前後の比較）
======================================================================

[補正後] Brier Score: 0.069219 (補正前: 0.073629)

  補正後キャリブレーション曲線（10分位）:
 prob_pred (予測確率)  prob_true (実績勝率)  diff (実績-予測)
         0.000000          0.013579      0.013579
         0.001047          0.036563      0.035516
         0.003462          0.050811      0.047349
         0.009466          0.067094      0.057628
         0.048393          0.113172      0.064779
         0.135244          0.154257      0.019014
         0.515227          0.278253     -0.236974

  補正後 平均キャリブレーション誤差: 0.067834 (補正前: 0.080082)

[補正後EV 10分位ごとの実績]
 ev_decile  n_bets  n_hits  hit_rate  avg_odds  avg_proba   avg_ev   ev_min    ev_max  return_rate  expected_return
         0   11919     918  0.077020 14.830623   0.001718 0.020125 0.001815  0.032592    82.084067         2.012460
         1   11905     718  0.060311 25.318832   0.003406 0.045292 0.032623  0.059120    80.302394         4.529208
         2   11914     717  0.060181 27.381140   0.006153 0.078613 0.059173  0.100852    73.775390         7.861308
         3   11904     798  0.067036 21.120783   0.010987 0.130036 0.100874  0.163335    80.793011        13.003596
         4   11923    1030  0.086388 18.858827   0.022007 0.207744 0.163345  0.260029    81.695882        20.774356
         5   11905    1431  0.120202 14.239857   0.048803 0.333371 0.260142  0.412941    82.341873        33.337149
         6   11908    1597  0.134112 10.662538   0.087684 0.516015 0.413333  0.629544    80.286362        51.601522
         7   11901    1994  0.167549  8.766120   0.170816 0.795013 0.629707  0.985373    79.624401        79.501295
         8   11917    2964  0.248720  6.653503   0.380905 1.235585 0.986301  1.535088    79.718050       123.558513
         9   11901    2119  0.178052  9.202386   0.489366 2.737900 1.536508 69.980952    84.481136       273.790026

[補正後 期待回収率 vs 実績回収率（EV分位別）]
 ev_decile  expected_return  return_rate  return_vs_expected
         0         2.012460    82.084067           40.787915
         1         4.529208    80.302394           17.729898
         2         7.861308    73.775390            9.384620
         3        13.003596    80.793011            6.213128
         4        20.774356    81.695882            3.932535
         5        33.337149    82.341873            2.469973
         6        51.601522    80.286362            1.555891
         7        79.501295    79.624401            1.001548
         8       123.558513    79.718050            0.645185
         9       273.790026    84.481136            0.308562

[補正後 全体サマリ]
  購入数: 119097
  的中数: 14286
  的中率: 0.1200
  実績回収率: 80.51%
  期待回収率(平均EV): 60.98%
  実績/期待: 1.3203

[補正前後の比較サマリ]
  指標                                 補正前          補正後         改善
  ------------------------------------------------------------
  Brier Score                   0.073629     0.069219 ✓
  平均キャリブ誤差                      0.080082     0.067834 ✓
  期待回収率                          228.21%       60.98%
  実績/期待                           0.3136       1.3203 ✓

[深掘り分析] TOP3の馬の特徴量詳細:

馬名: オーシャンビュー   (Target: 0, Odds: 150.3)
場所                                  東京
所属地                                  美
クラスコード                              67
芝・ダ                                  芝
トラックコード                              0
距離                                2400
馬場状態                                 稍
性別                                   牡
年齢                                   7
父馬名                           マヤノトップガン
斤量                                57.0
馬体重                                466
頭数                                  16
馬番                                   9
人気順                                 16
単勝オッズ                            150.3
騎手コード                             1051
調教師コード                            1031
生産者名                              八木明広
長距離輸送                                0
斤量変化                               4.0
馬体重変化                              6.0
過去平均着順                        7.288168
過去勝率                          0.079345
過去複勝率                         0.200281
過去出走数                               45
コース適性_平均着順                    7.189158
コース適性_勝率                      0.099181
コース適性_複勝率                     0.237194
コース適性_出走数                           26
芝ダ適性_平均着順                     7.819932
芝ダ適性_勝率                       0.076911
芝ダ適性_複勝率                      0.203843
芝ダ適性_出走数                             9
距離適性_平均着順                      7.70752
距離適性_勝率                       0.070755
距離適性_複勝率                      0.220535
距離適性_出走数                             0
prev_平均通過順                       11.75
prev_脚質指数                         -3.0
avg5_通過順1                          4.0
prev_場所                             中山
prev_距離                         1800.0
prev_芝・ダ                             芝
prev_確定着順                         11.0
prev_着差タイム                         1.1
avg5_上がり3Fタイム                    35.22
avg5_PCI                          53.4
wma5_上がり3Fタイム                35.641935
wma5_PCI                     53.141935
wma5_着差タイム                    1.083871
騎手勝率                          0.023636
調教師勝率                         0.035079
昇級フラグ                                0
降級フラグ                                0
interval                          22.0
proba_1                       0.505442
proba_1_calibrated            0.465608
expected_value               75.967859
expected_value_calibrated    69.980952
Name: 512153, dtype: object

馬名: フォーチュネイト   (Target: 0, Odds: 95.1)
場所                                  福島
所属地                                  美
クラスコード                              23
芝・ダ                                  ダ
トラックコード                              1
距離                                1700
馬場状態                                 良
性別                                   セ
年齢                                   6
父馬名                             フェノーメノ
斤量                                58.0
馬体重                                446
頭数                                  15
馬番                                  14
人気順                                 10
単勝オッズ                             95.1
騎手コード                             1029
調教師コード                            1093
生産者名                              須崎牧場
長距離輸送                                0
斤量変化                               0.0
馬体重変化                              0.0
過去平均着順                         7.73769
過去勝率                          0.063912
過去複勝率                         0.211644
過去出走数                               21
コース適性_平均着順                    7.791686
コース適性_勝率                      0.069368
コース適性_複勝率                      0.21621
コース適性_出走数                            1
芝ダ適性_平均着順                     7.541681
芝ダ適性_勝率                       0.065764
芝ダ適性_複勝率                      0.217779
芝ダ適性_出走数                            19
距離適性_平均着順                     7.570667
距離適性_勝率                       0.065764
距離適性_複勝率                      0.217779
距離適性_出走数                            19
prev_平均通過順                        7.75
prev_脚質指数                        -15.0
avg5_通過順1                          1.0
prev_場所                             東京
prev_距離                         1600.0
prev_芝・ダ                             ダ
prev_確定着順                          9.0
prev_着差タイム                         1.3
avg5_上がり3Fタイム                     38.0
avg5_PCI                         48.12
wma5_上がり3Fタイム                37.022581
wma5_PCI                     50.241935
wma5_着差タイム                    1.296774
騎手勝率                          0.022439
調教師勝率                         0.031998
昇級フラグ                                0
降級フラグ                                0
interval                          42.0
proba_1                       0.549764
proba_1_calibrated            0.574176
expected_value               52.282517
expected_value_calibrated    54.604121
Name: 643851, dtype: object

馬名: ゼンカイパイロ     (Target: 0, Odds: 86.3)
場所                                  京都
所属地                                  栗
クラスコード                               7
芝・ダ                                  ダ
トラックコード                              1
距離                                1200
馬場状態                                 良
性別                                   牡
年齢                                   3
父馬名                                パイロ
斤量                                57.0
馬体重                                490
頭数                                  16
馬番                                   2
人気順                                  9
単勝オッズ                             86.3
騎手コード                             1128
調教師コード                            1120
生産者名                              萩澤泰博
長距離輸送                                0
斤量変化                               0.0
馬体重変化                             -2.0
過去平均着順                        7.732863
過去勝率                          0.069368
過去複勝率                          0.21621
過去出走数                                1
コース適性_平均着順                    7.732863
コース適性_勝率                      0.069368
コース適性_複勝率                      0.21621
コース適性_出走数                            1
芝ダ適性_平均着順                     7.732863
芝ダ適性_勝率                       0.069368
芝ダ適性_複勝率                       0.21621
芝ダ適性_出走数                             1
距離適性_平均着順                     7.732863
距離適性_勝率                       0.069368
距離適性_複勝率                       0.21621
距離適性_出走数                             1
prev_平均通過順                         5.0
prev_脚質指数                        -10.0
avg5_通過順1                          0.0
prev_場所                             京都
prev_距離                         1400.0
prev_芝・ダ                             ダ
prev_確定着順                          9.0
prev_着差タイム                         1.8
avg5_上がり3Fタイム                     38.8
avg5_PCI                          45.3
wma5_上がり3Fタイム                     38.8
wma5_PCI                          45.3
wma5_着差タイム                         1.8
騎手勝率                           0.05965
調教師勝率                         0.060604
昇級フラグ                                0
降級フラグ                                1
interval                          63.0
proba_1                       0.538465
proba_1_calibrated            0.574176
expected_value               46.469529
expected_value_calibrated    49.551374
Name: 719695, dtype: object

データを読み込んでいます...
前処理を実行中...
データを分割中...
総レース数: 51813
時系列CV Fold数: 3
代表Fold - 学習用レース数: 31087, 検証用レース数: 5182, テスト用レース数: 15544
学習データサンプル数: 447591, 検証データサンプル数: 71881, テストデータサンプル数: 213805
LightGBMモデルを学習中...

[方針] validの回収率でモデル/閾値を選定し、testは最後に1回だけ評価します

[特徴量設定] prior_n=50, dist_bin_width=400 (固定)

[採用特徴量設定] prior_n=50, dist_bin_width=400

[時系列CV] 3つのFoldでモデルを評価します

[候補] P1_regularized を3つのFoldで評価...
Training until validation scores don't improve for 50 rounds
Did not meet early stopping. Best iteration is:
[1499]	valid_0's multi_logloss: 0.909377
Training until validation scores don't improve for 50 rounds
Did not meet early stopping. Best iteration is:
[1497]	valid_0's multi_logloss: 0.926661
Training until validation scores don't improve for 50 rounds
Did not meet early stopping. Best iteration is:
[1500]	valid_0's multi_logloss: 0.944864
  Fold回収率: [85.04097146806198, 88.40270501952568, 86.68765007463172] → 平均: 86.71%, 最小: 85.04%, CV安定: True

[候補] P3_high_reg を3つのFoldで評価...
Training until validation scores don't improve for 50 rounds
Did not meet early stopping. Best iteration is:
[1200]	valid_0's multi_logloss: 0.936704
Training until validation scores don't improve for 50 rounds
Did not meet early stopping. Best iteration is:
[1200]	valid_0's multi_logloss: 0.954601
Training until validation scores don't improve for 50 rounds
Did not meet early stopping. Best iteration is:
[1200]	valid_0's multi_logloss: 0.971783
  Fold回収率: [87.3450151057402, 84.15249125346845, 86.57867193859751] → 平均: 86.03%, 最小: 84.15%, CV安定: True

[モデル選定結果] CVの平均回収率で比較
            model  cv_avg_return(%)  cv_min_return(%)  ... proba_thr  ev_thr   bets
0  P1_regularized         86.710442         85.040971  ...       0.1     2.0  15409
1     P3_high_reg         86.025393         84.152491  ...       0.2     2.0   8599

[2 rows x 10 columns]

[最終学習] 選定されたモデル P1_regularized を全Trainデータで再学習...

[採用] model=P1_regularized, cv_avg_return=86.71%, cv_min=85.04%, proba_mode=raw, place>=0.0, proba>=0.1, EV>=2.0 (購入数=15409, cv_stable=True)

評価結果:
正解率 (Accuracy): 0.6297

分類レポート:
              precision    recall  f1-score   support

         その他       0.89      0.73      0.80    167137
          1着       0.24      0.47      0.31     15572
          2着       0.13      0.18      0.15     15540
          3着       0.11      0.18      0.13     15556

    accuracy                           0.63    213805
   macro avg       0.34      0.39      0.35    213805
weighted avg       0.73      0.63      0.67    213805


特徴量の重要度:
          feature  importance
16          騎手コード       38248
18           生産者名       32438
9             父馬名       31849
17         調教師コード       26845
15          単勝オッズ        4496
41        prev_場所        2286
50     wma5_着差タイム        2250
24          過去複勝率        2192
55       interval        2079
0              場所        1805
44      prev_確定着順        1716
23           過去勝率        1709
45     prev_着差タイム        1519
32       芝ダ適性_複勝率        1497
36       距離適性_複勝率        1496
38     prev_平均通過順        1458
49       wma5_PCI        1385
31        芝ダ適性_勝率        1337
21          馬体重変化        1318
14            人気順        1290
26     コース適性_平均着順        1290
34      距離適性_平均着順        1267
48  wma5_上がり3Fタイム        1232
30      芝ダ適性_平均着順        1228
13             馬番        1194
22         過去平均着順        1180
47       avg5_PCI        1175
35        距離適性_勝率        1152
39      prev_脚質指数        1052
46  avg5_上がり3Fタイム        1011
28      コース適性_複勝率         992
27       コース適性_勝率         757
12             頭数         692
51           騎手勝率         632
33       芝ダ適性_出走数         622
40      avg5_通過順1         605
11            馬体重         595
25          過去出走数         562
52          調教師勝率         558
37       距離適性_出走数         551
20           斤量変化         395
29      コース適性_出走数         393
42        prev_距離         365
2          クラスコード         299
5              距離         227
10             斤量         169
8              年齢         147
6            馬場状態          98
7              性別          57
53          昇級フラグ          57
54          降級フラグ          42
43       prev_芝・ダ          35
19          長距離輸送          34
4         トラックコード          25
3             芝・ダ          21
1             所属地           7

期待値（確率 × オッズ）によるパフォーマンス分析:
validで選定した戦略をtestで1回だけ評価: proba_mode=raw, place>=0.0, proba>=0.1, EV>=2.0
   proba閾値  期待値閾値    購入数 的中率(Precision) 再現率(Recall) 回収率(%)
0      0.1    2.0  49309         0.0592      0.1875  82.09

期待値が高い馬のサンプル (TOP 10) [選定後]:
           年   月   日     レース名  ...  単勝オッズ   proba_1  expected_value  target
512153  2020  10  11   六社Ｓ･3勝  ...  150.3  0.505442       75.967859       0
609380  2022  11   5  ノベンバ･3勝  ...  235.9  0.265419       62.612336       0
521126  2020  12   6    ２勝ｸﾗｽ  ...  174.5  0.354129       61.795532       0
519729  2020   9  19  レインＨ･3勝  ...  131.6  0.450495       59.285121       0
561772  2021  10  30  紅葉ＳＨ･3勝  ...  276.0  0.203169       56.074758       0
511786  2020   6  28  日野特別･2勝  ...  179.3  0.300344       53.851625       0
570665  2021  12  28   立志Ｓ･3勝  ...  184.7  0.288291       53.247401       0
643851  2023   7   8    １勝ｸﾗｽ  ...   95.1  0.549764       52.282517       0
578275  2021   2  14    ２勝ｸﾗｽ  ...  156.8  0.325960       51.110567       0
606415  2022   5  29  むらさＨ･3勝  ...  176.6  0.283601       50.083979       0

[10 rows x 9 columns]

的中馬の期待値TOP10 (的中数=2919):
           年   月   日     レース名  ...  単勝オッズ   proba_1  expected_value  target
553477  2021   8  21  瀬波温泉･2勝  ...   26.2  0.702014       18.392768       1
504527  2020   8   9   レパードG3  ...   22.3  0.592817       13.219818       1
525013  2020  10   4    ２勝ｸﾗｽ  ...   34.2  0.382446       13.079638       1
612035  2022   2  26      未勝利  ...   57.8  0.218490       12.628737       1
623878  2022  10   2     未勝利*  ...  100.5  0.125238       12.586457       1
626449  2022   3  12    ２勝ｸﾗｽ  ...   18.4  0.668911       12.307969       1
598213  2022  11  19     未勝利*  ...   52.1  0.233972       12.189950       1
565203  2021   3   6    １勝ｸﾗｽ  ...   30.4  0.395785       12.031854       1
622441  2022   6  11    １勝ｸﾗｽ  ...   27.9  0.421357       11.755858       1
581875  2021   6  19  オークラ･3勝  ...   27.3  0.413903       11.299561       1

[10 rows x 9 columns]

的中/非中途の特徴量比較 [購入対象内]:
                   hit_mean   hit_median    miss_mean  miss_median       diff
prev_距離         1673.212396  1700.000000  1658.955016  1600.000000  14.257380
距離              1670.945529  1700.000000  1657.536498  1700.000000  13.409031
単勝オッズ             13.867420    11.100000    22.215335    18.100000  -8.347914
単勝オッズ             13.867420    11.100000    22.215335    18.100000  -8.347914
人気順                5.264474     5.000000     6.584497     6.000000  -1.320023
馬体重              474.685851   474.000000   473.395967   474.000000   1.289885
expected_value     3.161155     2.761342     3.961539     3.240705  -0.800384
prev_着差タイム         8.196334     0.800000     7.573431     0.900000   0.622903
過去出走数              9.068859     7.000000     9.650063     7.000000  -0.581204
prev_確定着順          6.261905     6.000000     6.813960     6.000000  -0.552055
距離適性_出走数           4.888661     3.000000     5.399853     3.000000  -0.511192
wma5_着差タイム         7.855737     0.893548     7.472531     0.961290   0.383206
芝ダ適性_出走数           7.451182     5.000000     7.796818     5.000000  -0.345636
prev_脚質指数         -3.302343    -2.000000    -3.566576    -2.000000   0.264232
prev_平均通過順         4.543178     3.750000     4.776372     4.000000  -0.233193
コース適性_出走数          1.677629     1.000000     1.900930     1.000000  -0.223300
wma5_上がり3Fタイム     35.978690    36.506452    36.201439    36.606452  -0.222749
馬体重変化              1.724112     0.000000     1.525485     0.000000   0.198627
avg5_上がり3Fタイム     36.075552    36.440000    36.236123    36.566667  -0.160571
頭数                14.308325    15.000000    14.459484    15.000000  -0.151160

======================================================================
EV評価分析（全テストデータ対象）
======================================================================

[EV10分位ごとの実績]
 ev_decile  n_bets  n_hits  hit_rate   avg_odds  avg_proba   avg_ev   ev_min    ev_max  return_rate  expected_return
         0   21305     633  0.029711 147.228336   0.012835 0.260398 0.000661  0.511839    50.489556        26.039845
         1   21304    2002  0.093973  78.329539   0.089627 0.730291 0.511873  0.924858    68.525160        73.029117
         2   21304    3259  0.152976  50.697564   0.203345 1.079071 0.924876  1.222959    72.044686       107.907137
         3   21304    2762  0.129647  42.219654   0.221782 1.361475 1.222972  1.501229    71.397860       136.147534
         4   21304    2117  0.099371  43.371827   0.211689 1.653261 1.501245  1.813435    74.256008       165.326107
         5   21304    1663  0.078060  46.444818   0.191050 1.995786 1.813465  2.189930    73.320973       199.578593
         6   21304    1184  0.055576  50.937603   0.172028 2.416997 2.189942  2.666785    73.242584       241.699684
         7   21304     879  0.041260  59.087955   0.151280 2.979368 2.666794  3.336599    77.037646       297.936833
         8   21304     696  0.032670  68.240100   0.135937 3.848468 3.336605  4.488065    84.591157       384.846836
         9   21304     377  0.017696  85.540734   0.141442 6.495908 4.488137 75.967859    70.702685       649.590755

[期待回収率 vs 実績回収率（EV分位別）]
 ev_decile  expected_return  return_rate  return_vs_expected
         0        26.039845    50.489556            1.938935
         1        73.029117    68.525160            0.938327
         2       107.907137    72.044686            0.667655
         3       136.147534    71.397860            0.524415
         4       165.326107    74.256008            0.449149
         5       199.578593    73.320973            0.367379
         6       241.699684    73.242584            0.303031
         7       297.936833    77.037646            0.258570
         8       384.846836    84.591157            0.219805
         9       649.590755    70.702685            0.108842

[全体サマリ]
  購入数: 213041
  的中数: 15572
  的中率: 0.0731
  実績回収率: 71.56%
  期待回収率(平均EV): 228.21%
  実績/期待: 0.3136

[キャリブレーション評価]
  Brier Score: 0.073629 (低いほど良い)

  キャリブレーション曲線（10分位）:
 prob_pred (予測確率)  prob_true (実績勝率)  diff (実績-予測)
         0.002138          0.003695      0.001557
         0.009848          0.007109     -0.002738
         0.023749          0.014171     -0.009578
         0.045709          0.023012     -0.022697
         0.075992          0.033067     -0.042925
         0.115631          0.049906     -0.065724
         0.165854          0.066370     -0.099483
         0.230881          0.105795     -0.125086
         0.323338          0.148410     -0.174928
         0.532887          0.276788     -0.256099

  平均キャリブレーション誤差: 0.080082

[深掘り分析] TOP3の馬の特徴量詳細:

馬名: オーシャンビュー   (Target: 0, Odds: 150.3)
場所                       東京
所属地                       美
クラスコード                   67
芝・ダ                       芝
トラックコード                   0
距離                     2400
馬場状態                      稍
性別                        牡
年齢                        7
父馬名                マヤノトップガン
斤量                     57.0
馬体重                     466
頭数                       16
馬番                        9
人気順                      16
単勝オッズ                 150.3
騎手コード                  1051
調教師コード                 1031
生産者名                   八木明広
長距離輸送                     0
斤量変化                    4.0
馬体重変化                   6.0
過去平均着順             7.288168
過去勝率               0.079345
過去複勝率              0.200281
過去出走数                    45
コース適性_平均着順         7.189158
コース適性_勝率           0.099181
コース適性_複勝率          0.237194
コース適性_出走数                26
芝ダ適性_平均着順          7.819932
芝ダ適性_勝率            0.076911
芝ダ適性_複勝率           0.203843
芝ダ適性_出走数                  9
距離適性_平均着順           7.70752
距離適性_勝率            0.070755
距離適性_複勝率           0.220535
距離適性_出走数                  0
prev_平均通過順            11.75
prev_脚質指数              -3.0
avg5_通過順1               4.0
prev_場所                  中山
prev_距離              1800.0
prev_芝・ダ                  芝
prev_確定着順              11.0
prev_着差タイム              1.1
avg5_上がり3Fタイム         35.22
avg5_PCI               53.4
wma5_上がり3Fタイム     35.641935
wma5_PCI          53.141935
wma5_着差タイム         1.083871
騎手勝率               0.023636
調教師勝率              0.035079
昇級フラグ                     0
降級フラグ                     0
interval               22.0
単勝オッズ                 150.3
proba_1            0.505442
expected_value    75.967859
Name: 512153, dtype: object

馬名: シャチ             (Target: 0, Odds: 235.9)
場所                       東京
所属地                       美
クラスコード                   67
芝・ダ                       芝
トラックコード                   0
距離                     1800
馬場状態                      良
性別                        牡
年齢                        5
父馬名                リアルインパクト
斤量                     57.0
馬体重                     478
頭数                       10
馬番                        6
人気順                      10
単勝オッズ                 235.9
騎手コード                  1173
調教師コード                 1005
生産者名                   松浦牧場
長距離輸送                     0
斤量変化                    6.0
馬体重変化                   6.0
過去平均着順             8.088168
過去勝率               0.068818
過去複勝率              0.158176
過去出走数                    45
コース適性_平均着順          8.17775
コース適性_勝率           0.055277
コース適性_複勝率          0.172293
コース適性_出走数                14
芝ダ適性_平均着順          8.088168
芝ダ適性_勝率            0.068818
芝ダ適性_複勝率           0.158176
芝ダ適性_出走数                 45
距離適性_平均着順          8.087809
距離適性_勝率             0.07783
距離適性_複勝率            0.17889
距離適性_出走数                 34
prev_平均通過順              1.5
prev_脚質指数              -3.0
avg5_通過順1               0.0
prev_場所                  東京
prev_距離              1600.0
prev_芝・ダ                  芝
prev_確定着順              10.0
prev_着差タイム              0.6
avg5_上がり3Fタイム         33.78
avg5_PCI              57.34
wma5_上がり3Fタイム     33.716129
wma5_PCI          58.083871
wma5_着差タイム         0.874194
騎手勝率               0.022519
調教師勝率              0.029345
昇級フラグ                     0
降級フラグ                     0
interval                7.0
単勝オッズ                 235.9
proba_1            0.265419
expected_value    62.612336
Name: 609380, dtype: object

馬名: ホクセンジョウオー (Target: 0, Odds: 174.5)
場所                       中山
所属地                       美
クラスコード                   43
芝・ダ                       芝
トラックコード                   0
距離                     2500
馬場状態                      良
性別                        牝
年齢                        5
父馬名                 サムライハート
斤量                     55.0
馬体重                     490
頭数                       12
馬番                        7
人気順                      11
単勝オッズ                 174.5
騎手コード                  1096
調教師コード                 1100
生産者名                  佐々木康治
長距離輸送                     0
斤量変化                    3.0
馬体重変化                   4.0
過去平均着順             7.948228
過去勝率               0.079111
過去複勝率              0.214668
過去出走数                    20
コース適性_平均着順         7.708351
コース適性_勝率           0.062066
コース適性_複勝率          0.228539
コース適性_出走数                 7
芝ダ適性_平均着順           7.85847
芝ダ適性_勝率            0.081437
芝ダ適性_複勝率           0.220981
芝ダ適性_出走数                 18
距離適性_平均着順            7.7896
距離適性_勝率            0.075629
距離適性_複勝率           0.217112
距離適性_出走数                 10
prev_平均通過順             15.5
prev_脚質指数               0.0
avg5_通過順1              10.4
prev_場所                  福島
prev_距離              2600.0
prev_芝・ダ                  芝
prev_確定着順              10.0
prev_着差タイム              1.2
avg5_上がり3Fタイム         36.52
avg5_PCI               52.9
wma5_上がり3Fタイム     36.158065
wma5_PCI          55.529032
wma5_着差タイム         1.335484
騎手勝率                0.05733
調教師勝率               0.04068
昇級フラグ                     0
降級フラグ                     0
interval               29.0
単勝オッズ                 174.5
proba_1            0.354129
expected_value    61.795532
Name: 521126, dtype: object

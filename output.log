データを読み込んでいます...
前処理を実行中...
データを分割中...
総レース数: 51813
時系列CV Fold数: 3
代表Fold - 学習用レース数: 31087, 検証用レース数: 5182, テスト用レース数: 15544
学習データサンプル数: 447591, 検証データサンプル数: 71881, テストデータサンプル数: 213805
LightGBMモデルを学習中...

[方針] validの回収率でモデル/閾値を選定し、testは最後に1回だけ評価します

[探索] APTITUDE_PRIOR_N を valid回収率で探索します
Training until validation scores don't improve for 50 rounds
[50]	valid_0's multi_logloss: 1.06321
[100]	valid_0's multi_logloss: 1.03112
[150]	valid_0's multi_logloss: 1.01783
[200]	valid_0's multi_logloss: 1.00136
[250]	valid_0's multi_logloss: 0.985187
[300]	valid_0's multi_logloss: 0.969826
[350]	valid_0's multi_logloss: 0.95607
[400]	valid_0's multi_logloss: 0.942975
Did not meet early stopping. Best iteration is:
[400]	valid_0's multi_logloss: 0.942975
Training until validation scores don't improve for 50 rounds
[50]	valid_0's multi_logloss: 1.06302
[100]	valid_0's multi_logloss: 1.03049
[150]	valid_0's multi_logloss: 1.01679
[200]	valid_0's multi_logloss: 1.0012
[250]	valid_0's multi_logloss: 0.98608
[300]	valid_0's multi_logloss: 0.970597
[350]	valid_0's multi_logloss: 0.957724
[400]	valid_0's multi_logloss: 0.944966
Did not meet early stopping. Best iteration is:
[400]	valid_0's multi_logloss: 0.944966
Training until validation scores don't improve for 50 rounds
[50]	valid_0's multi_logloss: 1.06285
[100]	valid_0's multi_logloss: 1.03072
[150]	valid_0's multi_logloss: 1.01736
[200]	valid_0's multi_logloss: 1.00183
[250]	valid_0's multi_logloss: 0.986815
[300]	valid_0's multi_logloss: 0.971573
[350]	valid_0's multi_logloss: 0.958657
[400]	valid_0's multi_logloss: 0.945935
Did not meet early stopping. Best iteration is:
[400]	valid_0's multi_logloss: 0.945935
Training until validation scores don't improve for 50 rounds
[50]	valid_0's multi_logloss: 1.06277
[100]	valid_0's multi_logloss: 1.03084
[150]	valid_0's multi_logloss: 1.01744
[200]	valid_0's multi_logloss: 1.00149
[250]	valid_0's multi_logloss: 0.986085
[300]	valid_0's multi_logloss: 0.971131
[350]	valid_0's multi_logloss: 0.957593
[400]	valid_0's multi_logloss: 0.944801
Did not meet early stopping. Best iteration is:
[400]	valid_0's multi_logloss: 0.944801
   prior_n  valid_acc  best_valid_return(%)  ... ev_thr  bets  stable
3       50   0.629054             92.398050  ...    1.0  8411    True
0        0   0.630083             90.619250  ...    1.0  8478    True
1       10   0.628873             89.576782  ...    1.2  8459    True
2       20   0.628761             89.414206  ...    1.2  8433    True

[4 rows x 9 columns]
[選定] best_prior_n=50

[探索] DIST_BIN_WIDTH を valid回収率で探索します
Training until validation scores don't improve for 50 rounds
[50]	valid_0's multi_logloss: 1.06273
[100]	valid_0's multi_logloss: 1.03013
[150]	valid_0's multi_logloss: 1.01738
[200]	valid_0's multi_logloss: 1.00183
[250]	valid_0's multi_logloss: 0.986
[300]	valid_0's multi_logloss: 0.970957
[350]	valid_0's multi_logloss: 0.957598
[400]	valid_0's multi_logloss: 0.945144
Did not meet early stopping. Best iteration is:
[400]	valid_0's multi_logloss: 0.945144
Training until validation scores don't improve for 50 rounds
[50]	valid_0's multi_logloss: 1.06277
[100]	valid_0's multi_logloss: 1.03084
[150]	valid_0's multi_logloss: 1.01744
[200]	valid_0's multi_logloss: 1.00149
[250]	valid_0's multi_logloss: 0.986085
[300]	valid_0's multi_logloss: 0.971131
[350]	valid_0's multi_logloss: 0.957593
[400]	valid_0's multi_logloss: 0.944801
Did not meet early stopping. Best iteration is:
[400]	valid_0's multi_logloss: 0.944801
Training until validation scores don't improve for 50 rounds
[50]	valid_0's multi_logloss: 1.06339
[100]	valid_0's multi_logloss: 1.03141
[150]	valid_0's multi_logloss: 1.0181
[200]	valid_0's multi_logloss: 1.00208
[250]	valid_0's multi_logloss: 0.986979
[300]	valid_0's multi_logloss: 0.971824
[350]	valid_0's multi_logloss: 0.958503
[400]	valid_0's multi_logloss: 0.946016
Did not meet early stopping. Best iteration is:
[400]	valid_0's multi_logloss: 0.946016
   dist_bin_width  valid_acc  best_valid_return(%)  ... ev_thr  bets  stable
2             400   0.628914             94.649400  ...    1.5  9498    True
0             100   0.630097             93.344502  ...    1.2  8357    True
1             200   0.629054             92.398050  ...    1.0  8411    True

[3 rows x 9 columns]
[選定] best_dist_bin_width=400

[採用特徴量設定] prior_n=50, dist_bin_width=400

[時系列CV] 3つのFoldでモデルを評価します

[候補] P0_less_reg を3つのFoldで評価...
Training until validation scores don't improve for 50 rounds
Did not meet early stopping. Best iteration is:
[1000]	valid_0's multi_logloss: 0.825094
Training until validation scores don't improve for 50 rounds
Did not meet early stopping. Best iteration is:
[1000]	valid_0's multi_logloss: 0.840676
Training until validation scores don't improve for 50 rounds
Did not meet early stopping. Best iteration is:
[1000]	valid_0's multi_logloss: 0.856878
  Fold回収率: [86.66335403726707, 88.93048128342245, 95.33101879564228] → 平均: 90.31%, 最小: 86.66%, CV安定: True

[候補] P1_regularized を3つのFoldで評価...
Training until validation scores don't improve for 50 rounds
Did not meet early stopping. Best iteration is:
[1500]	valid_0's multi_logloss: 0.910382
Training until validation scores don't improve for 50 rounds
Did not meet early stopping. Best iteration is:
[1499]	valid_0's multi_logloss: 0.92703
Training until validation scores don't improve for 50 rounds
Did not meet early stopping. Best iteration is:
[1500]	valid_0's multi_logloss: 0.944853
  Fold回収率: [88.57220060527452, 88.29268292682927, 92.65433969889865] → 平均: 89.84%, 最小: 88.29%, CV安定: True

[候補] P2_medium を3つのFoldで評価...
Training until validation scores don't improve for 50 rounds
Did not meet early stopping. Best iteration is:
[1200]	valid_0's multi_logloss: 0.852368
Training until validation scores don't improve for 50 rounds
Did not meet early stopping. Best iteration is:
[1200]	valid_0's multi_logloss: 0.867459
Training until validation scores don't improve for 50 rounds
Did not meet early stopping. Best iteration is:
[1200]	valid_0's multi_logloss: 0.882299
  Fold回収率: [86.757892468484, 89.39095592444191, 92.77854023705552] → 平均: 89.64%, 最小: 86.76%, CV安定: True

[候補] P3_high_reg を3つのFoldで評価...
Training until validation scores don't improve for 50 rounds
Did not meet early stopping. Best iteration is:
[1199]	valid_0's multi_logloss: 0.937579
Training until validation scores don't improve for 50 rounds
Did not meet early stopping. Best iteration is:
[1200]	valid_0's multi_logloss: 0.954361
Training until validation scores don't improve for 50 rounds
Did not meet early stopping. Best iteration is:
[1199]	valid_0's multi_logloss: 0.97217
  Fold回収率: [91.53288935623321, 89.73178807947019, 90.26928343222274] → 平均: 90.51%, 最小: 89.73%, CV安定: True

[モデル選定結果] CVの平均回収率で比較
            model  cv_avg_return(%)  cv_min_return(%)  ... proba_thr  ev_thr  bets
3     P3_high_reg         90.511320         89.731788  ...      0.04     1.5  8764
0     P0_less_reg         90.308285         86.663354  ...      0.02     1.5  8353
1  P1_regularized         89.839741         88.292683  ...      0.02     1.5  9897
2       P2_medium         89.642463         86.757892  ...      0.07     1.2  8015

[4 rows x 10 columns]

[最終学習] 選定されたモデル P3_high_reg を全Trainデータで再学習...

[採用] model=P3_high_reg, cv_avg_return=90.51%, cv_min=89.73%, proba_mode=race_sum, place>=0.3, proba>=0.04, EV>=1.5 (購入数=8764, cv_stable=True)

評価結果:
正解率 (Accuracy): 0.6176

分類レポート:
              precision    recall  f1-score   support

         その他       0.90      0.71      0.79    167137
          1着       0.24      0.49      0.32     15572
          2着       0.13      0.19      0.16     15540
          3着       0.11      0.18      0.14     15556

    accuracy                           0.62    213805
   macro avg       0.34      0.39      0.35    213805
weighted avg       0.74      0.62      0.67    213805


特徴量の重要度:
          feature  importance
16          騎手コード       28627
9             父馬名       24656
18           生産者名       22107
17         調教師コード       21643
15          単勝オッズ        4275
41        prev_場所        2188
50     wma5_着差タイム        2120
0              場所        1915
24          過去複勝率        1876
44      prev_確定着順        1538
23           過去勝率        1504
38     prev_平均通過順        1402
32       芝ダ適性_複勝率        1389
49       wma5_PCI        1368
45     prev_着差タイム        1367
14            人気順        1289
36       距離適性_複勝率        1288
48  wma5_上がり3Fタイム        1276
31        芝ダ適性_勝率        1241
47       avg5_PCI        1210
46  avg5_上がり3Fタイム        1172
21          馬体重変化        1171
22         過去平均着順        1141
26     コース適性_平均着順        1119
34      距離適性_平均着順        1117
30      芝ダ適性_平均着順        1104
13             馬番        1069
39      prev_脚質指数         991
35        距離適性_勝率         952
51           騎手勝率         811
28      コース適性_複勝率         801
40      avg5_通過順1         769
11            馬体重         766
52          調教師勝率         684
12             頭数         637
27       コース適性_勝率         621
33       芝ダ適性_出走数         569
25          過去出走数         551
37       距離適性_出走数         502
2          クラスコード         351
42        prev_距離         344
29      コース適性_出走数         320
20           斤量変化         299
5              距離         254
10             斤量         196
8              年齢         174
6            馬場状態          82
7              性別          62
53          昇級フラグ          45
43       prev_芝・ダ          43
4         トラックコード          43
19          長距離輸送          38
54          降級フラグ          38
3             芝・ダ          25
1             所属地           6

期待値（確率 × オッズ）によるパフォーマンス分析:
validで選定した戦略をtestで1回だけ評価: proba_mode=race_sum, place>=0.3, proba>=0.04, EV>=1.5
   proba閾値  期待値閾値    購入数 的中率(Precision) 再現率(Recall) 回収率(%)
0     0.04    1.5  26212         0.0338      0.0568  78.49

期待値が高い馬のサンプル (TOP 10) [選定後]:
         年   月   日     レース名  ...  単勝オッズ   proba_1  expected_value  target
511786  20   6  28  日野特別･2勝  ...  179.3  0.131173       23.519351       0
519729  20   9  19  レインＨ･3勝  ...  131.6  0.160249       21.088824       0
570665  21  12  28   立志Ｓ･3勝  ...  184.7  0.109935       20.304969       0
512153  20  10  11   六社Ｓ･3勝  ...  150.3  0.126483       19.010372       0
578275  21   2  14    ２勝ｸﾗｽ  ...  156.8  0.116322       18.239285       0
644049  23   7   9   七夕賞ＨG3  ...  194.8  0.087753       17.094343       0
511936  20  10  10    １勝ｸﾗｽ  ...  127.2  0.134248       17.076387       0
606415  22   5  29  むらさＨ･3勝  ...  176.6  0.096502       17.042210       0
500413  20   7   4    １勝ｸﾗｽ  ...  132.3  0.121842       16.119666       3
609052  22  10  29  紅葉ＳＨ･3勝  ...  159.8  0.098876       15.800359       0

[10 rows x 9 columns]

[深掘り分析] TOP3の馬の特徴量詳細:

馬名: ヤマニンリュシオル (Target: 0, Odds: 179.3)
場所                       東京
所属地                       美
クラスコード                   43
芝・ダ                       ダ
トラックコード                   1
距離                     1600
馬場状態                      不
性別                        牝
年齢                        5
父馬名               キャプテントゥーレ
斤量                     55.0
馬体重                     492
頭数                       16
馬番                        2
人気順                      15
単勝オッズ                 179.3
騎手コード                  1119
調教師コード                 1131
生産者名                   錦岡牧場
長距離輸送                     0
斤量変化                    0.0
馬体重変化                  16.0
過去平均着順             7.912125
過去勝率               0.086527
過去複勝率              0.219168
過去出走数                    14
コース適性_平均着順         7.497824
コース適性_勝率           0.097153
コース適性_複勝率          0.246083
コース適性_出走数                 7
芝ダ適性_平均着順          7.912125
芝ダ適性_勝率            0.086527
芝ダ適性_複勝率           0.219168
芝ダ適性_出走数                 14
距離適性_平均着順          8.040965
距離適性_勝率            0.078237
距離適性_複勝率           0.207357
距離適性_出走数                  8
prev_平均通過順             4.75
prev_脚質指数             -11.0
avg5_通過順1               2.0
prev_場所                  東京
prev_距離              1600.0
prev_芝・ダ                  ダ
prev_確定着順               8.0
prev_着差タイム              0.6
avg5_上がり3Fタイム         38.02
avg5_PCI               47.8
wma5_上がり3Fタイム     37.664516
wma5_PCI          48.816129
wma5_着差タイム         1.654839
騎手勝率               0.031841
調教師勝率              0.033518
昇級フラグ                     0
降級フラグ                     0
単勝オッズ                 179.3
proba_1            0.131173
expected_value    23.519351
Name: 511786, dtype: object

馬名: オーシャンビュー   (Target: 0, Odds: 131.6)
場所                       中山
所属地                       美
クラスコード                   67
芝・ダ                       芝
トラックコード                   0
距離                     1800
馬場状態                      良
性別                        牡
年齢                        7
父馬名                マヤノトップガン
斤量                     53.0
馬体重                     460
頭数                       14
馬番                        6
人気順                      14
単勝オッズ                 131.6
騎手コード                  1051
調教師コード                 1031
生産者名                   八木明広
長距離輸送                     0
斤量変化                   -4.0
馬体重変化                   0.0
過去平均着順             7.248681
過去勝率               0.080189
過去複勝率              0.202412
過去出走数                    44
コース適性_平均着順         7.780679
コース適性_勝率            0.06675
コース適性_複勝率          0.208052
コース適性_出走数                 3
芝ダ適性_平均着順          7.765103
芝ダ適性_勝率            0.078237
芝ダ適性_複勝率           0.207357
芝ダ適性_出走数                  8
距離適性_平均着順           7.27761
距離適性_勝率            0.071919
距離適性_複勝率           0.221126
距離適性_出走数                 27
prev_平均通過順              6.5
prev_脚質指数             -13.0
avg5_通過順1               2.0
prev_場所                  新潟
prev_距離              1800.0
prev_芝・ダ                  芝
prev_確定着順              14.0
prev_着差タイム              1.7
avg5_上がり3Fタイム         35.86
avg5_PCI              51.16
wma5_上がり3Fタイム     35.987097
wma5_PCI          51.422581
wma5_着差タイム         1.067742
騎手勝率               0.023767
調教師勝率              0.035333
昇級フラグ                     0
降級フラグ                     0
単勝オッズ                 131.6
proba_1            0.160249
expected_value    21.088824
Name: 519729, dtype: object

馬名: シャチ             (Target: 0, Odds: 184.7)
場所                       中山
所属地                       美
クラスコード                   67
芝・ダ                       芝
トラックコード                   8
距離                     1600
馬場状態                      良
性別                        牡
年齢                        4
父馬名                リアルインパクト
斤量                     57.0
馬体重                     474
頭数                       12
馬番                        7
人気順                      12
単勝オッズ                 184.7
騎手コード                  1173
調教師コード                 1005
生産者名                   松浦牧場
長距離輸送                     0
斤量変化                    4.0
馬体重変化                   8.0
過去平均着順             7.671143
過去勝率                0.07783
過去複勝率               0.17889
過去出走数                    34
コース適性_平均着順          7.43454
コース適性_勝率           0.087901
コース適性_複勝率          0.222647
コース適性_出走数                13
芝ダ適性_平均着順          7.671143
芝ダ適性_勝率             0.07783
芝ダ適性_複勝率            0.17889
芝ダ適性_出走数                 34
距離適性_平均着順          7.797091
距離適性_勝率            0.084906
距離適性_複勝率           0.195152
距離適性_出走数                 27
prev_平均通過順              4.0
prev_脚質指数              -9.0
avg5_通過順1               0.0
prev_場所                  東京
prev_距離              1600.0
prev_芝・ダ                  芝
prev_確定着順              13.0
prev_着差タイム              0.7
avg5_上がり3Fタイム         34.16
avg5_PCI               56.0
wma5_上がり3Fタイム     34.196774
wma5_PCI          55.064516
wma5_着差タイム         0.854839
騎手勝率               0.022586
調教師勝率              0.029889
昇級フラグ                     0
降級フラグ                     0
単勝オッズ                 184.7
proba_1            0.109935
expected_value    20.304969
Name: 570665, dtype: object

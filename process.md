# 回収率改善 PDCAログ（特徴量追加・削除）

## 目的
- 目的: 当日予測を前提に、**回収率（単勝）**を改善する
- 手段: 学習に使う特徴量（カラム）を仮説ベースで追加/削除し、同一条件で評価する

## 前提（リーク対策）
- 未来リーク禁止: 当該レースの結果由来カラム（走破タイム/着差/通過順/確定着順など）は特徴量に使わない
- 例外: **過去レースの結果（prev_***）は既知情報なので利用可
- `prev_*` は **血統登録番号**でグルーピングして作成（同名馬の混入を防止）

## データ
- 入力: `csv/data.csv`（cp932, 52カラム）
- サンプル数: 733,277行
- レース単位: `race_id = レースIDの末尾2桁を除去`
- 目的変数: `rank_class`（0=その他, 1=1着, 2=2着, 3=3着）

## 分割（時系列・レース単位）
- `race_id` を時系列順に並べ、レース単位で分割
- train/valid/test = 70% / 10% / 20%
- early stopping は valid のみ（testで停止判断しない）

## 学習モデル
- LightGBM: `LGBMClassifier(objective='multiclass', num_class=4, class_weight='balanced', random_state=42, n_estimators=100)`

## 回収率評価（単勝）
- 予測: `predict_proba` の **1着クラス確率**を使用
- レース内で確率を正規化: `proba_1 = proba_1_raw / sum(proba_1_raw by race)`
- 期待値: `expected_value = proba_1 * 単勝オッズ`
- フィルタ: `proba_1 >= 0.1`
- 閾値: `expected_value >= {0.8, 1.0, 1.2, 1.5, 2.0}`
- 回収率(%): `(的中馬の単勝オッズ合計 / 購入数) * 100`

## ベースライン特徴量（E00）
- 基本: `場所, 所属地, クラスコード, 芝・ダ, トラックコード, 距離, 馬場状態, 性別, 年齢, 斤量, 頭数, 馬番, 騎手コード, 調教師コード`
- 追加: `長距離輸送, 斤量変化`
- 1走前（血統登録番号ベース）: `prev_場所, prev_距離, prev_芝・ダ, prev_確定着順, prev_着差タイム, prev_上がり3Fタイム, prev_PCI`

## 現時点の暫定ベスト（E10）
- 追加採用した主な特徴量: `人気順, 単勝オッズ, 馬体重, 生産者名, 父馬名`
- ベスト回収率（EV基準）: EV>=1.2 → `85.15%`（EV>=1.0 → `84.69%`）

---

## 実験ログ

### E00: ベースライン（2026-01-11）

**Plan（仮説）**
- 現状の「レース当日で確定する情報 + 直近1走情報」で回収率の基準値を取る。

**Do（変更）**
- 変更なし（`main.py` のベースライン特徴量のまま）。

**Check（結果）**
- Accuracy: `0.5261`
- valid multi_logloss(best): `1.17794`
- 回収率（条件: `proba_1 >= 0.1`）
  - EV>=0.8: 購入数=14785, 的中率=0.0647, 再現率=0.0921, 回収率=76.64%
  - EV>=1.0: 購入数=11770, 的中率=0.0515, 再現率=0.0584, 回収率=76.77%
  - EV>=1.2: 購入数=9900, 的中率=0.0419, 再現率=0.0400, 回収率=75.39%
  - EV>=1.5: 購入数=7916, 的中率=0.0337, 再現率=0.0257, 回収率=74.88%
  - EV>=2.0: 購入数=5705, 的中率=0.0266, 再現率=0.0146, 回収率=76.00%

**Act（次の打ち手）**
- 回収率が100%未満なので、情報量のある特徴量候補（例: 市場情報/馬体重/休養/変化量）を順に追加し、改善するか確認する。

### E01: `prev_確定着順` と `prev_着差タイム` を除外（2026-01-11）

**Plan（仮説）**
- 前走結果（着順/着差）は強すぎて「人気寄り」になる可能性があり、外すことで妙味（回収率）が上がるかもしれない。

**Do（変更）**
- `features` から `prev_確定着順`, `prev_着差タイム` を削除。

**Check（結果）**
- Accuracy: `0.5087`
- valid multi_logloss(best): `1.21622`
- 回収率（条件: `proba_1 >= 0.1`）
  - EV>=0.8: 購入数=14660, 的中率=0.0555, 再現率=0.0784, 回収率=75.04%
  - EV>=1.0: 購入数=12484, 的中率=0.0451, 再現率=0.0543, 回収率=74.59%
  - EV>=1.2: 購入数=11009, 的中率=0.0384, 再現率=0.0408, 回収率=73.82%
  - EV>=1.5: 購入数=9307, 的中率=0.0288, 再現率=0.0258, 回収率=69.69%
  - EV>=2.0: 購入数=7401, 的中率=0.0216, 再現率=0.0154, 回収率=67.19%

**Act（判断）**
- ベースラインより **精度/回収率ともに悪化**したため、`prev_確定着順` と `prev_着差タイム` は **復活**（採用）する。

### E02: 市場情報（人気順）を追加（2026-01-11）

**Plan（仮説）**
- 当日予測ではオッズ由来の情報が最も強い可能性が高い。まずは「人気順」を入れて予測確率の質が上がれば、期待値フィルタの回収率も改善するはず。

**Do（変更）**
- 追加: `人気順`
- 実装: `features` に `人気順` を追加し、数値変換も追加。

**Check（結果）**
- Accuracy: `0.5758`
- valid multi_logloss(best): `1.07441`
- 回収率（条件: `proba_1 >= 0.1`）
  - EV>=0.8: 購入数=14109, 的中率=0.0920, 再現率=0.1251, 回収率=79.06%
  - EV>=1.0: 購入数=8577, 的中率=0.0674, 再現率=0.0557, 回収率=77.83%
  - EV>=1.2: 購入数=5911, 的中率=0.0555, 再現率=0.0316, 回収率=78.59%
  - EV>=1.5: 購入数=3843, 的中率=0.0463, 再現率=0.0172, 回収率=79.99%
  - EV>=2.0: 購入数=2063, 的中率=0.0344, 再現率=0.0068, 回収率=77.12%

**Act（判断）**
- ベースラインより **logloss/accuracy/回収率（特にEV>=1.5）** が改善したため、`人気順` は **採用**して次の実験に進む。

### E03: 市場情報（単勝オッズ）を追加（2026-01-11）

**Plan（仮説）**
- `人気順` だけだと情報が粗いので、連続値の `単勝オッズ` を入れて市場評価をより正確に取り込むと、勝率推定が改善し、EVフィルタの回収率も上がるはず。

**Do（変更）**
- 追加: `単勝オッズ`
- 追加: 数値変換（`df["単勝オッズ"] = pd.to_numeric(... )`）

**Check（結果）**
- Accuracy: `0.5828`
- valid multi_logloss(best): `1.0638`
- 回収率（条件: `proba_1 >= 0.1`）
  - EV>=0.8: 購入数=15546, 的中率=0.1012, 再現率=0.1516, 回収率=80.85%
  - EV>=1.0: 購入数=8669, 的中率=0.0833, 再現率=0.0696, 回収率=82.73%
  - EV>=1.2: 購入数=5095, 的中率=0.0663, 再現率=0.0326, 回収率=80.03%
  - EV>=1.5: 購入数=2380, 的中率=0.0525, 再現率=0.0120, 回収率=80.07%
  - EV>=2.0: 購入数=929, 的中率=0.0409, 再現率=0.0037, 回収率=82.16%

**Act（判断）**
- E02より **回収率が明確に改善（EV>=1.0で82.73%）**したため、`単勝オッズ` は **採用**する。

### E04: 馬体重を追加（2026-01-11）

**Plan（仮説）**
- 当日予測では馬体重が状態（仕上がり/成長/絞り）を反映しうるため、勝率推定と回収率が改善する可能性がある。

**Do（変更）**
- 追加: `馬体重`
- 追加: 数値変換（`df["馬体重"] = pd.to_numeric(... )`）

**Check（結果）**
- Accuracy: `0.5833`
- valid multi_logloss(best): `1.0630`
- 回収率（条件: `proba_1 >= 0.1`）
  - EV>=0.8: 購入数=15179, 的中率=0.1037, 再現率=0.1517, 回収率=82.15%
  - EV>=1.0: 購入数=8450, 的中率=0.0819, 再現率=0.0667, 回収率=82.17%
  - EV>=1.2: 購入数=5018, 的中率=0.0686, 再現率=0.0332, 回収率=83.43%
  - EV>=1.5: 購入数=2393, 的中率=0.0531, 再現率=0.0122, 回収率=81.61%
  - EV>=2.0: 購入数=934, 的中率=0.0385, 再現率=0.0035, 回収率=76.23%

**Act（判断）**
- EV>=1.0 は微減だが、EV>=1.2 が **83.43%** と改善したため、当面 `馬体重` は **採用**して次の仮説検証へ進む。

### E05: 直近1走の「変化量・間隔」を追加（2026-01-11）

**Plan（仮説）**
- 距離替わり/芝ダ替わり/場所替わり/休養間隔はパフォーマンスに影響しやすい。直近1走との差分を入れると回収率が改善する可能性がある。

**Do（変更）**
- 追加: `前走間隔日数, 距離変化, 芝ダ変化, 場所変化`

**Check（結果）**
- Accuracy: `0.5851`
- valid multi_logloss(best): `1.06148`
- 回収率（条件: `proba_1 >= 0.1`）
  - EV>=0.8: 購入数=15171, 的中率=0.1034, 再現率=0.1511, 回収率=81.17%
  - EV>=1.0: 購入数=8497, 的中率=0.0830, 再現率=0.0679, 回収率=81.66%
  - EV>=1.2: 購入数=4978, 的中率=0.0657, 再現率=0.0315, 回収率=79.00%
  - EV>=1.5: 購入数=2421, 的中率=0.0504, 再現率=0.0118, 回収率=75.95%
  - EV>=2.0: 購入数=876, 的中率=0.0411, 再現率=0.0035, 回収率=78.53%

**Act（判断）**
- E04より回収率が悪化したため、上記4特徴は **不採用**として取り下げ。

### E06: 血統（父馬名・母の父馬名）を追加（2026-01-11）

**Plan（仮説）**
- 血統は能力・適性に影響するため、父/母父をカテゴリとして追加すると回収率が上がる可能性がある。

**Do（変更）**
- 追加: `父馬名, 母の父馬名`（カテゴリとして扱う）

**Check（結果）**
- Accuracy: `0.5889`
- valid multi_logloss(best): `1.05025`
- 回収率（条件: `proba_1 >= 0.1`）
  - EV>=0.8: 購入数=16166, 的中率=0.1040, 再現率=0.1620, 回収率=80.69%
  - EV>=1.0: 購入数=9269, 的中率=0.0796, 再現率=0.0711, 回収率=79.19%
  - EV>=1.2: 購入数=5626, 的中率=0.0659, 再現率=0.0358, 回収率=78.81%
  - EV>=1.5: 購入数=2992, 的中率=0.0565, 再現率=0.0163, 回収率=81.34%
  - EV>=2.0: 購入数=1349, 的中率=0.0326, 再現率=0.0042, 回収率=61.66%

**Act（判断）**
- 精度/loglossは改善したが、回収率が悪化し、特に EV>=2.0 が大きく崩れたため **不採用**（除外）。

### E07: 毛色を追加（2026-01-11）

**Plan（仮説）**
- 毛色は適性というよりノイズ寄りだが、カテゴリ数が少なく（8種）モデル負荷も軽いので、わずかでも回収率が上がるか確認する。

**Do（変更）**
- 追加: `毛色`（カテゴリ）

**Check（結果）**
- Accuracy: `0.5836`
- valid multi_logloss(best): `1.06298`
- 回収率（条件: `proba_1 >= 0.1`）
  - EV>=0.8: 購入数=15214, 的中率=0.1038, 再現率=0.1522, 回収率=82.00%
  - EV>=1.0: 購入数=8511, 的中率=0.0802, 再現率=0.0658, 回収率=80.12%
  - EV>=1.2: 購入数=5020, 的中率=0.0661, 再現率=0.0320, 回収率=80.03%
  - EV>=1.5: 購入数=2413, 的中率=0.0506, 再現率=0.0118, 回収率=76.25%
  - EV>=2.0: 購入数=927, 的中率=0.0410, 再現率=0.0037, 回収率=80.71%

**Act（判断）**
- E04より回収率が悪化したため **不採用**。

### E08: 生産者名を追加（2026-01-11）

**Plan（仮説）**
- 生産牧場には育成・血統の傾向があり、当日情報に加えて入れると回収率が改善する可能性がある（カテゴリ数も約2751で許容範囲）。

**Do（変更）**
- 追加: `生産者名`（カテゴリ）

**Check（結果）**
- Accuracy: `0.5896`
- valid multi_logloss(best): `1.04909`
- 回収率（条件: `proba_1 >= 0.1`）
  - EV>=0.8: 購入数=16671, 的中率=0.1010, 再現率=0.1622, 回収率=80.12%
  - EV>=1.0: 購入数=9521, 的中率=0.0832, 再現率=0.0763, 回収率=82.22%
  - EV>=1.2: 購入数=5700, 的中率=0.0712, 再現率=0.0391, 回収率=84.66%
  - EV>=1.5: 購入数=2884, 的中率=0.0485, 再現率=0.0135, 回収率=74.66%
  - EV>=2.0: 購入数=1198, 的中率=0.0384, 再現率=0.0044, 回収率=75.98%

**Act（判断）**
- EV>=1.2 が **84.66%** と改善（現時点で最高）したため、`生産者名` は **採用**。

### E09: 馬主名を追加（生産者名と併用）（2026-01-11）

**Plan（仮説）**
- オーナーの購買力/厩舎選択が成績に影響する可能性があるため、生産者に加えて `馬主名` も入れると回収率がさらに上がるかもしれない。

**Do（変更）**
- 追加: `馬主名`（カテゴリ）

**Check（結果）**
- Accuracy: `0.5846`
- valid multi_logloss(best): `1.05282`
- 回収率（条件: `proba_1 >= 0.1`）
  - EV>=0.8: 購入数=17560, 的中率=0.0994, 再現率=0.1682, 回収率=78.13%
  - EV>=1.0: 購入数=10490, 的中率=0.0793, 再現率=0.0802, 回収率=78.59%
  - EV>=1.2: 購入数=6686, 的中率=0.0663, 再現率=0.0427, 回収率=78.35%
  - EV>=1.5: 購入数=3684, 的中率=0.0554, 再現率=0.0197, 回収率=79.83%
  - EV>=2.0: 購入数=1724, 的中率=0.0365, 再現率=0.0061, 回収率=70.10%

**Act（判断）**
- E08より回収率が悪化したため、`馬主名` は **不採用**（除外）し、`生産者名` のみ維持。

### E10: 父馬名を追加（生産者名は維持）（2026-01-11）

**Plan（仮説）**
- E06では血統を増やしすぎて不安定になった可能性がある。まずはカテゴリ数が比較的少ない `父馬名`（約1388種）だけを追加すると、過学習を抑えつつ回収率が上がるかもしれない。

**Do（変更）**
- 追加: `父馬名`（カテゴリ）

**Check（結果）**
- Accuracy: `0.5898`
- valid multi_logloss(best): `1.05074`
- 回収率（条件: `proba_1 >= 0.1`）
  - EV>=0.8: 購入数=16157, 的中率=0.1029, 再現率=0.1602, 回収率=81.11%
  - EV>=1.0: 購入数=9047, 的中率=0.0850, 再現率=0.0741, 回収率=84.69%
  - EV>=1.2: 購入数=5372, 的中率=0.0711, 再現率=0.0368, 回収率=85.15%
  - EV>=1.5: 購入数=2745, 的中率=0.0572, 再現率=0.0151, 回収率=85.11%
  - EV>=2.0: 購入数=1099, 的中率=0.0409, 再現率=0.0043, 回収率=78.74%

**Act（判断）**
- 回収率が大きく改善したため（EV>=1.0で84.69%、EV>=1.2で85.15%）、`父馬名` は **採用**。

### E11: 母の父馬名を追加（父馬名+生産者名に上乗せ）（2026-01-11）

**Plan（仮説）**
- 父だけで良かった可能性はあるが、母父も適性に影響するため追加で回収率がさらに上がるか確認する。

**Do（変更）**
- 追加: `母の父馬名`（カテゴリ）

**Check（結果）**
- Accuracy: `0.5869`
- valid multi_logloss(best): `1.05152`
- 回収率（条件: `proba_1 >= 0.1`）
  - EV>=0.8: 購入数=16807, 的中率=0.1043, 再現率=0.1689, 回収率=81.77%
  - EV>=1.0: 購入数=9990, 的中率=0.0806, 再現率=0.0776, 回収率=81.38%
  - EV>=1.2: 購入数=6229, 的中率=0.0681, 再現率=0.0409, 回収率=82.35%
  - EV>=1.5: 購入数=3445, 的中率=0.0546, 再現率=0.0181, 回収率=82.39%
  - EV>=2.0: 購入数=1557, 的中率=0.0411, 再現率=0.0062, 回収率=82.83%

**Act（判断）**
- E10より回収率が悪化したため `母の父馬名` は **不採用**。

### E12: 回次・日次を追加（2026-01-11）

**Plan（仮説）**
- 開催回/開催日目は馬場傾向や出走馬層の偏りを含む可能性があるため、当日情報として追加して回収率が上がるか検証する。

**Do（変更）**
- 追加: `回次, 日次`（カテゴリ）

**Check（結果）**
- Accuracy: `0.5897`
- valid multi_logloss(best): `1.05009`
- 回収率（条件: `proba_1 >= 0.1`）
  - EV>=0.8: 購入数=16269, 的中率=0.1019, 再現率=0.1597, 回収率=79.76%
  - EV>=1.0: 購入数=9143, 的中率=0.0840, 再現率=0.0740, 回収率=82.60%
  - EV>=1.2: 購入数=5457, 的中率=0.0704, 再現率=0.0370, 回収率=82.48%
  - EV>=1.5: 購入数=2762, 的中率=0.0547, 再現率=0.0146, 回収率=79.06%
  - EV>=2.0: 購入数=1104, 的中率=0.0317, 再現率=0.0034, 回収率=58.89%

**Act（判断）**
- E10より回収率が悪化したため `回次, 日次` は **不採用**。

### E13: 血統登録番号（馬ID）を追加（2026-01-11）

**Plan（仮説）**
- 馬IDを入れると「馬の地力」を直接学習でき、勝率推定が改善し回収率も上がる可能性がある。

**Do（変更）**
- 追加: `血統登録番号`（カテゴリ）

**Check（結果）**
- Accuracy: `0.6074`
- valid multi_logloss(best): `1.03288`
- 回収率（条件: `proba_1 >= 0.1`）
  - EV>=0.8: 購入数=14140, 的中率=0.1064, 再現率=0.1450, 回収率=81.23%
  - EV>=1.0: 購入数=6060, 的中率=0.0865, 再現率=0.0505, 回収率=83.63%
  - EV>=1.2: 購入数=2667, 的中率=0.0716, 再現率=0.0184, 回収率=83.51%
  - EV>=1.5: 購入数=948, 的中率=0.0485, 再現率=0.0044, 回収率=73.35%
  - EV>=2.0: 購入数=348, 的中率=0.0431, 再現率=0.0014, 回収率=77.21%

**Act（判断）**
- 精度/loglossは大幅に改善したが、回収率の改善はE10に及ばなかったため **不採用**。

### E14: 母馬名を追加（高カーディナリティ）（2026-01-11）

**Plan（仮説）**
- 母系も能力に影響しうるため `母馬名` を追加すると改善する可能性がある（ただしカテゴリ数が多い）。

**Do（変更）**
- 追加: `母馬名`（カテゴリ）

**Check（結果）**
- Accuracy: `0.5783`
- valid multi_logloss(best): `1.07384`（early stopping: best iteration 26）
- 回収率（条件: `proba_1 >= 0.1`）
  - EV>=0.8: 購入数=11144, 的中率=0.0922, 再現率=0.0990, 回収率=77.19%
  - EV>=1.0: 購入数=5531, 的中率=0.0714, 再現率=0.0381, 回収率=75.42%
  - EV>=1.2: 購入数=2939, 的中率=0.0558, 再現率=0.0158, 回収率=71.78%
  - EV>=1.5: 購入数=1431, 的中率=0.0377, 再現率=0.0052, 回収率=64.07%
  - EV>=2.0: 購入数=743, 的中率=0.0296, 再現率=0.0021, 回収率=64.95%

**Act（判断）**
- 回収率/精度ともに大きく悪化したため **不採用**。

### E15: `proba_1 >= 0.1` フィルタを削除（2026-01-11）

**Plan（仮説）**
- 予測確率の下限を外すと、低確率だが高オッズの馬も拾えるため、EV基準だけで選別したときに回収率が上がる可能性がある。

**Do（変更）**
- 変更: `valid_mask = win_proba >= 0.1` を廃止し、全件を対象に（`valid_mask = True` 相当）にした。

**Check（結果）**
- Accuracy: `0.5898`
- valid multi_logloss(best): `1.05074`
- 回収率（条件: フィルタなし）
  - EV>=0.8: 購入数=94872, 的中率=0.0367, 再現率=0.3357, 回収率=71.47%
  - EV>=1.0: 購入数=73591, 的中率=0.0286, 再現率=0.2027, 回収率=70.32%
  - EV>=1.2: 購入数=55109, 的中率=0.0234, 再現率=0.1241, 回収率=68.68%
  - EV>=1.5: 購入数=34183, 的中率=0.0185, 再現率=0.0609, 回収率=67.66%
  - EV>=2.0: 購入数=14361, 的中率=0.0130, 再現率=0.0179, 回収率=60.10%

**Act（判断）**
- 購入数が大幅に増え、回収率も悪化したため、`proba_1 >= 0.1` フィルタは **有効**（復活推奨）。

### E16: `人気順`/`単勝オッズ` を特徴量から削除（フィルタなしのまま）（2026-01-11）

**Plan（仮説）**
- 市場情報を特徴量から外すことで人気に引っ張られにくくなり、EV基準の回収率が改善する可能性がある。

**Do（変更）**
- 変更: 学習特徴量から `人気順` と `単勝オッズ` を削除（※回収率計算のためオッズ自体は評価で使用）。

**Check（結果）**
- Accuracy: `0.5311`
- valid multi_logloss(best): `1.1702`
- 回収率（条件: フィルタなし）
  - EV>=0.8: 購入数=97785, 的中率=0.0256, 再現率=0.2417, 回収率=66.78%
  - EV>=1.0: 購入数=88625, 的中率=0.0202, 再現率=0.1726, 回収率=64.72%
  - EV>=1.2: 購入数=81065, 的中率=0.0169, 再現率=0.1320, 回収率=64.31%
  - EV>=1.5: 購入数=71732, 的中率=0.0135, 再現率=0.0933, 回収率=63.36%
  - EV>=2.0: 購入数=59789, 的中率=0.0098, 再現率=0.0564, 回収率=60.51%

**Act（判断）**
- 学習性能・回収率ともに悪化したため、`人気順`/`単勝オッズ` は **特徴量として有効**（復活推奨）。

### E17: proba閾値をスイープ（2026-01-11）

**Plan（仮説）**
- `proba_1 >= 0.1` の閾値は固定ではなく、最適なラインがあるかもしれない。閾値を上げると購入数は減るが回収率が上がる可能性がある。

**Do（変更）**
- `proba_1` 閾値を `0.00〜0.30`（0.01刻み）でスイープ。
- 各 `proba閾値` について、`期待値閾値={0.8,1.0,1.2,1.5,2.0}` の中から **回収率(%)が最大**になる組み合わせを抽出。

**Check（結果）**
- 全体最大（参考・超不安定）: `proba>=0.30 & EV>=1.2` → 回収率 `145.00%`（購入数=6）
- 安定版（購入数>=1000）最大: `proba>=0.17 & EV>=1.0` → 回収率 `93.78%`（購入数=1012）
- 次点: `proba>=0.16 & EV>=1.0` → 回収率 `93.71%`（購入数=1377）
- 既存設定（E10相当）: `proba>=0.10 & EV>=1.2` → 回収率 `85.15%`（購入数=5372）

**Act（判断）**
- 「購入数を確保しつつ回収率を上げる」観点では、`proba閾値` を **0.16〜0.17** 付近に上げると改善余地がある。
- ただし回収率はまだ100%未満なので、次は `期待値閾値` の候補を細かくする（例: 0.9〜1.5を0.1刻み）/ `proba_1` 正規化方式の見直しも検討。

### E18: 前走の上がり3F/PCIを「過去平均+減衰平均」に置換（2026-01-12）

**Plan（仮説）**
- 直前1走だけだとブレが大きいので、過去の傾向（平均）と直近寄りの傾向（減衰平均）を入れると安定する。

**Do（変更）**
- `prev_上がり3Fタイム`, `prev_PCI` を削除し、`avg_上がり3Fタイム/avg_PCI` と `ewm_上がり3Fタイム/ewm_PCI` を追加。

**Check（結果）**
- Accuracy: `0.5905`
- valid multi_logloss(best): `1.04982`
- 回収率（条件: `proba_1 >= 0.1`）
  - EV>=1.2: `85.47%`
- 安定版（購入数>=1000）最大: `92.46%`（proba>=0.17, EV>=1.0, 購入数=1085）

**Act（判断）**
- 平均/減衰平均の方向性は悪くないが、さらに「直近N走」に絞る改善を試す。

### E19: 直近3走の平均/加重平均（2026-01-12）

**Plan（仮説）**
- 過去全レース平均はノイズが入る可能性があるため、直近3走に絞ると回収率が改善するかもしれない。

**Do（変更）**
- `avg3_*`, `wma3_*`（重み: 0.2/0.3/0.5）を追加。

**Check（結果）**
- Accuracy: `0.5902`
- valid multi_logloss(best): `1.04936`
- 回収率（条件: `proba_1 >= 0.1`）
  - EV>=1.2: `81.43%`
- 安定版（購入数>=1000）最大: `89.66%`（proba>=0.19, EV>=0.8, 購入数=1445）

**Act（判断）**
- 3走は短すぎる可能性。直近5走 + 重みパターン化を試す。

### E20: 直近5走 + 重みパターン化（2026-01-12）

**Plan（仮説）**
- 直近5走程度なら過去のノイズを抑えつつ、馬の地力も拾える。

**Do（変更）**
- `ROLLING_WINDOW=5` にし、`avg5_*`, `wma5_*` を追加。
- 重みを `WEIGHT_PATTERNS` で切替可能に。

**Check（結果 / exp重み）**
- Accuracy: `0.5903`
- valid multi_logloss(best): `1.04921`
- 回収率（条件: `proba_1 >= 0.1`）
  - EV>=1.2: `82.00%`

**Act（判断）**
- 重みの当たり外れより、別系統の特徴量（馬体重変化/過去成績）を強化する。

### E21: 馬体重変化 + 過去平均着順 + モデル強化（2026-01-12）

**Plan（仮説）**
- 直近のコンディション（馬体重変化）と、地力の代理（過去平均着順）を追加すると回収率が上がる。
- 学習が足りていないので、木の数/学習率を見直す。

**Do（変更）**
- `prev_馬体重` 追加 → `馬体重変化` を追加。
- `過去平均着順` を追加。
- `n_estimators=300, learning_rate=0.05` に変更。

**Check（結果）**
- Accuracy: `0.6023`
- valid multi_logloss(best): `1.02596`
- 回収率（条件: `proba_1 >= 0.1`）
  - EV>=1.2: `87.67%`

**Act（判断）**
- 過去成績系の集計特徴量が効くので、コース/芝ダ/距離帯の適性を高速に追加する。

### E22: 適性特徴量（コース/芝ダ/距離bin）+ 脚質特徴量 + スムージング（2026-01-12）

**Plan（仮説）**
- 「同コース/同芝ダ/同距離帯」の過去成績は強い。
- ただし小標本だとノイズが出るので、事前分布でスムージングすると回収率が安定する。

**Do（変更）**
- 適性特徴量（平均着順/勝率/複勝率/出走数）を `cumsum` ベースで追加。
- 脚質特徴量（`prev_平均通過順`, `prev_脚質指数`, `avg5_通過順1`）を追加。
- スムージング: `APTITUDE_PRIOR_N=20` を導入。
- `過去勝率/過去複勝率/過去出走数` を追加。

**Check（結果）**
- Accuracy: `0.6431`
- valid multi_logloss(best): `0.946118`
- 回収率（条件: `proba_1 >= 0.1`）
  - EV>=1.5: `90.08%`
  - EV>=2.0: `86.64%`
- 安定版（購入数>=1000）最大: `99.72%`（proba>=0.11, EV>=2.0, 購入数=1157）

**Act（判断）**
- 回収率の指標では、精度/損失よりも「正則化強め」の方が良い可能性。LightGBMの小スイープを実施。

### E23: LightGBM小スイープ（回収率最適化）（2026-01-12）

**Plan（仮説）**
- 回収率は確率の形（キャリブレーション）に敏感なので、強めの正則化で安定版回収率が上がる可能性がある。

**Do（変更）**
- 2候補を比較（テストの安定版指標で比較）
  - P0（基準）: `n_estimators=1000, lr=0.03, leaves=63, depth=8, min_child=50, reg=0.1/0.1`
  - P1（正則化強め）: `n_estimators=1500, lr=0.05, leaves=31, depth=6, min_child=100, reg=0.5/1.0`

**Check（結果）**
- P0 安定版最大: `99.72%`（proba>=0.11, EV>=2.0, 購入数=1157）
- P1 安定版最大: `102.27%`（proba>=0.12, EV>=2.0, 購入数=1655）

**Act（判断）**
- 安定版で100%超えを達成したP1を採用。

### E24: 評価方式の修正（validで選定→testは最終1回）（2026-01-12）

**Plan（仮説）**
- testで閾値（proba/EV）やハイパラを選ぶと、回収率が過大評価（リーク）になりやすい。
- validで「モデル/閾値」を選定し、testは最終評価として1回だけ見る方が再現性が上がる。

**Do（変更）**
- `main.py` を変更し、以下を実施:
  - 複数モデル候補を学習
  - **validの安定版回収率（購入数>=1000）**で「モデル + proba閾値 + EV閾値」を選定
  - 選定した戦略を **testで1回だけ評価**

**Check（結果）**
- validでの選定（購入数>=1000）
  - P0_less_reg: best_valid_return=`94.59%`（proba>=0.16, EV>=1.5, 購入数=1146）
  - P1_regularized: best_valid_return=`93.64%`（proba>=0.16, EV>=1.5, 購入数=1091）
  - 採用: **P0_less_reg**
- test最終評価（validで選んだ戦略を適用）
  - proba>=0.16, EV>=1.5 → 回収率=`96.29%`（購入数=1797）

**Act（判断）**
- 今後の実験はこの評価方式を前提に進める（testでの閾値最適化は禁止）。

<!-- PDCA_LOG -->

# 競馬 AI 開発ロードマップ

現在の状況: `data/` ディレクトリにスクレイピング済みの RAW HTML データが格納されている。
目標: 各馬券の期待値を算出し、期待値が 1 を超える馬券を購入する AI を作成する。

## 1. データ前処理 (Preprocessing)

HTML データから構造化データ(DataFrame)への変換を行います。

- **タスク**:
  - `data/html/` 内の HTML ファイルを読み込む。
  - BeautifulSoup を使用して必要な情報を抽出する。
    - **レース情報**: レース ID, 日付, 場所, コース情報(芝/ダート, 距離), 天候, 馬場状態など。
    - **出走馬情報**: 枠番, 馬番, 馬名, 騎手, 斤量, 所属, 調教師など。
    - **レース結果**: 着順, タイム, 着差, 上がり 3F など（学習用）。
    - **オッズ情報**: 単勝, 複勝, その他券種のオッズ（学習用・シミュレーション用）。
    - **払い戻し情報**: 実際の払い戻し金額（シミュレーション用）。
  - 抽出したデータを結合し、`pandas.DataFrame` として保存する (例: `data/processed/raw_data.pkl` または `parquet`)。

## 2. 特徴量エンジニアリング (Feature Engineering)

モデルが学習しやすい形にデータを加工します。

- **タスク**:
  - **データクリーニング**: 欠損値の処理, データ型の変換。
  - **特徴量作成**:
    - カテゴリ変数の処理 (LabelEncoding/TargetEncoding)。
    - 過去の戦績集計 (過去 N 走の着順平均, タイム指数など)。
    - 騎手・調教師の勝率データ結合。
    - レース条件との相性 (コース適性, 距離適性)。
  - 学習用データ(X)とターゲット(y)の作成。
    - ターゲット案: 1 着になる確率 (Binary Classification), 複勝圏内確率, または着順そのもの (Ranking)。

## 3. モデル学習 (Model Training)

LightGBM などの勾配ブースティング決定木を用いて予測モデルを構築します。

- **タスク**:
  - データを学習用(Train), 検証用(Valid), テスト用(Test)に分割 (時系列分割を推奨)。
  - LightGBM モデルの構築と学習。
  - Optuna を用いたハイパーパラメータチューニング。
  - モデルの評価 (AUC, LogLoss, Accuracy など)。
  - 特徴量重要度(Feature Importance)の確認。

## 4. 期待値計算とシミュレーション (Simulation)

モデルの予測確率とオッズを組み合わせて期待値を計算し、回収率を検証します。

- **タスク**:
  - **予測**: テストデータに対して勝率を予測。
  - **期待値算出**: `期待値 = 予測確率 × オッズ`。
  - **シミュレーション**:
    - 期待値 > 1 (または任意の閾値) の馬券を購入した場合の収支を計算。
    - 閾値ごとの回収率・的中率をプロット。
    - 最適な購入戦略(資金配分など)の検討。

## 5. 実運用・推論パイプライン (Production)

新規レースデータに対して予測を行い、購入リストを出力する仕組みを作ります。

- **タスク**:
  - 新規出馬表 HTML の取得処理 (スクレイピング)。
  - 前処理・特徴量作成パイプラインの適用。
  - 学習済みモデルによる推論。
  - 期待値リストの出力と購入候補の提示。

B. “弱いリーク” を潰す（回収率の再現性が上がる）
特徴量は概ね「過去のみ」で作れていますが、**事前分布（global平均）**の作り方が全期間平均になっていて、未来情報が定数として混ざります。定数とはいえ、CV/テストの整合性が崩れて「検証は良いのに実運用で落ちる」原因になりがちです。

B-1) aptitudeの global_win_rate などを「過去時点の累積」にする
add_aptitude_features() の

global_avg_rank
global_win_rate
global_place_rate
が 全データ平均です。
提案: これも cumsum を使って「その行より前までの全体平均」を作り、priorとして使う（時点整合）。

簡単な方針：

df_sorted 全体で _win の累積平均（shift込み）を作り、その行の prior にする
prior_n はそのままでも良い（調整余地あり）
B-2) target encoding の global_win_rate_te も同様に時点依存へ
add_encoding_features() の global_win_rate_te = mean() も全期間平均です。
これも「過去までの平均」に変えると、安定性が上がります。

C. 戦略探索が“validに過適合”している（回収率最大化で最重要）
今の select_best_strategy_on_valid() は valid に対して閾値をスイープし、最大の回収率（または信頼性）を選びます。
これは構造的に**選択バイアス（データスヌーピング）**が入りやすく、テストで落ちます。

C-1) 閾値選びを「ネスト」する（fold内で further split）
提案（王道）: 各CV foldのvalidをさらに前半/後半に分け、

valid前半で閾値を決める
valid後半で回収率を評価する
こうすると「閾値の汎化」が測れ、回収率の再現性が上がります。

C-2) いまのCV集計が“最後のfoldの閾値”に寄っている
train_and_evaluate_cv() で final_res = fold_results[-1] を使って戦略の行を作っており、最後のfoldの戦略パラメータだけが記録されます。
提案: foldごとに出た最適閾値を集計して

中央値（median）の閾値を採用
もしくは「foldをまたいで最も成績が良い閾値」を再探索（ただし別のホールドアウトで検証）
C-3) 探索空間が粗い＆固定フィルタが強すぎる可能性
ev_thresholds=[1.0,1.5,2.0] は粗い
fixed_odds_min=5.0 を固定は、機会損失/歪みが出やすい
提案:

odds_min も探索対象にする（例: 1.5〜20を数点）
EV閾値は分位点ベースにする（例: valid内EVの上位x%を買う）
→ 分布変化に強く、時期が変わっても崩れにくいです。
D. 確率を「レース内の勝率」として扱う（当たり前だが効く）
あなたのコードにも race_sum 正規化がありますが、デフォルト探索が ["raw"] だけになっています。
競馬は「1レース1勝者」なので、確率をレース内で整合させる発想は正しいです。

D-1) win_proba_modes に race_sum を常に含めて比較
提案: 戦略探索で win_proba_modes_override=None のデフォルトを ["raw","race_sum"] にして、両方を毎回比較。
raw は校正の形が崩れやすい一方、race_sum は「相対評価」になりやすく、オッズとのEV整合が良くなるケースがあります。

D-2) Isotonicは過学習しやすいので “cross-fitting” か “beta calibration” も検討
Isotonicは柔軟な分、サンプルが薄い領域で過適合しやすいです。
提案（軽量）:

Isotonicを「CVで学習→別期間で適用」（cross-fitting）
代替として Platt scaling（ロジスティック）や Beta calibration を試す
回収率というより「EVの信頼性（実績/期待）」が安定しやすいです。
追加で効きやすい“地味だけど重要”な改善
E-1) class_weight="balanced" をやめる（少なくともEV目的では要検証）
balanced は「分類精度」には効くことがありますが、確率の絶対値を歪めやすいです。
回収率は確率×オッズなので、まず外して logloss/brier と回収率の両方で比較した方が良いです。

E-2) 「同日同場」のレース結果を特徴量に使っていないか方針を決める
今の並び順だと、同日同場の後ろのレースの特徴量が、同日同場の前レース結果を含み得ます（cumsumなので未来は入らないが“当日内”は入る）。
「レース直前に逐次更新して買う」運用ならOKですが、
「朝まとめて買う」想定ならリークなので、日単位でブロックする必要があります。